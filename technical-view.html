<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Technical View - LED Wall Calculator</title>
  <link rel="stylesheet" href="css/main.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 95%;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 10px;
    }

    .screen-info {
      text-align: center;
      margin-bottom: 30px;
      padding: 15px;
      background: #f0f0f0;
      border-radius: 5px;
    }

    .screen-info h2 {
      margin: 5px 0;
      color: #555;
      font-size: 18px;
    }

    .diagram-section {
      margin-bottom: 50px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    }

    .diagram-section h2 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
      font-size: 22px;
    }

    .controls {
      margin-bottom: 20px;
      padding: 15px;
      background: #e8f4f8;
      border-radius: 5px;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: inline-block;
      min-width: 150px;
      font-weight: bold;
      font-size: 14px;
    }

    .input-group select {
      padding: 5px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }

    .canvas-wrapper {
      border: 2px solid #ddd;
      border-radius: 5px;
      background: #fff;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: auto;
      max-height: 800px;
    }

    canvas {
      display: block;
      max-width: 100%;
    }

    .back-button {
      display: inline-block;
      margin-bottom: 20px;
      padding: 10px 20px;
      background: #0066cc;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      font-weight: bold;
    }

    .back-button:hover {
      background: #0052a3;
    }

    .capture-button {
      display: inline-block;
      padding: 10px 20px;
      background: #17a2b8;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 15px;
    }

    .capture-button:hover {
      background: #138496;
    }

    .capture-container {
      text-align: center;
      margin-top: 20px;
    }

    .zoom-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }

    .zoom-button {
      padding: 8px 16px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    .zoom-button:hover {
      background: #218838;
    }

    .zoom-level {
      padding: 8px 16px;
      background: #f0f0f0;
      border-radius: 5px;
      font-weight: bold;
      display: flex;
      align-items: center;
    }

    .capture-both-container {
      text-align: center;
      margin: 30px 0;
      padding: 20px;
      background: #e8f4f8;
      border-radius: 8px;
    }

    .capture-both-button {
      display: inline-block;
      padding: 15px 30px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
    }

    .capture-both-button:hover {
      background: #c82333;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="index.html" class="back-button" id="backButton">‚Üê Back to Calculator</a>

    <h1>Technical View - Wiring Diagrams</h1>

    <div class="screen-info">
      <h2 id="productInfo">Product: Loading...</h2>
      <h2 id="dimensionsInfo">Screen Size: Loading...</h2>
    </div>

    <!-- Data Wiring Section -->
    <div class="diagram-section">
      <h2>Data Wiring Diagram</h2>

      <div class="controls">
        <div class="input-group">
          <label for="wiringDirection">Wiring Direction:</label>
          <select id="wiringDirection" name="wiringDirection">
            <option value="horizontal">Horizontal</option>
            <option value="vertical">Vertical</option>
          </select>
        </div>
        <div class="input-group">
          <label for="wiringStartPosition">Start Position:</label>
          <select id="wiringStartPosition" name="wiringStartPosition">
            <option value="bottom-left">Bottom Left</option>
            <option value="bottom-right">Bottom Right</option>
            <option value="top-left">Top Left</option>
            <option value="top-right">Top Right</option>
          </select>
        </div>
      </div>

      <div class="canvas-wrapper">
        <canvas id="dataWiringCanvas"></canvas>
      </div>

      <div class="zoom-controls">
        <button type="button" class="zoom-button" id="dataZoomOutButton">Zoom Out</button>
        <div class="zoom-level" id="dataZoomLevel">Zoom: 1</div>
        <button type="button" class="zoom-button" id="dataZoomInButton">Zoom In</button>
      </div>

      <div class="capture-container">
        <button type="button" class="capture-button" id="captureDataButton">üì∏ Capture Data Wiring</button>
      </div>
    </div>

    <!-- Power Wiring Section -->
    <div class="diagram-section">
      <h2>Power Wiring Diagram</h2>

      <div class="controls">
        <div class="input-group">
          <label for="powerDirection">Wiring Direction:</label>
          <select id="powerDirection" name="powerDirection">
            <option value="horizontal">Horizontal</option>
            <option value="vertical">Vertical</option>
          </select>
        </div>
        <div class="input-group">
          <label for="powerStartPosition">Start Position:</label>
          <select id="powerStartPosition" name="powerStartPosition">
            <option value="bottom-left">Bottom Left</option>
            <option value="bottom-right">Bottom Right</option>
            <option value="top-left">Top Left</option>
            <option value="top-right">Top Right</option>
          </select>
        </div>
        <div class="input-group">
          <label for="powerDistroType">Power Voltage:</label>
          <select id="powerDistroType" name="powerDistroType">
            <option value="110">110V</option>
            <option value="208">208V</option>
          </select>
        </div>
      </div>

      <div class="canvas-wrapper">
        <canvas id="powerWiringCanvas"></canvas>
      </div>

      <div class="zoom-controls">
        <button type="button" class="zoom-button" id="powerZoomOutButton">Zoom Out</button>
        <div class="zoom-level" id="powerZoomLevel">Zoom: 1</div>
        <button type="button" class="zoom-button" id="powerZoomInButton">Zoom In</button>
      </div>

      <div class="capture-container">
        <button type="button" class="capture-button" id="capturePowerButton">üì∏ Capture Power Wiring</button>
      </div>
    </div>

    <!-- Capture Both Screens Button -->
    <div class="capture-both-container">
      <button type="button" class="capture-both-button" id="captureBothButton">üì∏ Capture Both Diagrams</button>
    </div>
  </div>

  <script src="js/canvas.js?v=20251121c"></script>
  <script>
    // Get screen parameters from URL
    function getScreenParameters() {
      const urlParams = new URLSearchParams(window.location.search);

      return {
        productType: urlParams.get('product') || 'absen',
        blocksHor: parseInt(urlParams.get('blocksHor') || '10'),
        blocksVer: parseInt(urlParams.get('blocksVer') || '6'),
        powerDistroType: urlParams.get('powerDistroType') || '208'
      };
    }

    const params = getScreenParameters();

    // Product display names
    const productNames = {
      'absen': 'Absen PL2.5',
      'theatrixx': 'Theatrixx Nomad 2.6',
      'BP2B1': 'ROE Black Pearl BP2B1',
      'BP2B2': 'ROE Black Pearl BP2B2',
      'BP2V2': 'ROE Black Pearl BP2V2'
    };

    // Update info display
    const displayName = productNames[params.productType] || params.productType.toUpperCase();
    document.getElementById('productInfo').textContent = `Product: ${displayName}`;
    document.getElementById('dimensionsInfo').textContent = `Screen Size: ${params.blocksHor} √ó ${params.blocksVer} tiles`;

    // Update back button to preserve calculator state
    const backButton = document.getElementById('backButton');
    backButton.href = `index.html?product=${encodeURIComponent(params.productType)}&blocksHor=${params.blocksHor}&blocksVer=${params.blocksVer}`;

    // Set power distro type
    const powerDistroTypeSelect = document.getElementById('powerDistroType');
    if (powerDistroTypeSelect) {
      powerDistroTypeSelect.value = params.powerDistroType;
    }

    // Initialize canvas renderer
    CanvasRenderer.init();

    // Global state variables
    window.wiringDirection = 'horizontal';
    window.wiringStartPosition = 'bottom-left';
    window.powerDirection = 'horizontal';
    window.powerStartPosition = 'bottom-left';

    // Separate zoom levels for each diagram
    let dataZoomLevel = 1;
    let powerZoomLevel = 1;

    // Wall data
    const wallData = {
      blocksHor: params.blocksHor,
      blocksVer: params.blocksVer,
      flownSupport: false,
      groundSupport: false
    };

    // Function to render data wiring diagram
    function renderDataWiring() {
      window.showWiring = true;
      window.showPower = false;

      // Temporarily change the canvas ID that CanvasRenderer uses
      const originalCanvas = document.getElementById('wallCanvas2D');
      const dataCanvas = document.getElementById('dataWiringCanvas');

      // Copy ID to data canvas temporarily
      if (dataCanvas) {
        dataCanvas.id = 'wallCanvas2D';
        if (originalCanvas) originalCanvas.id = 'wallCanvas2D_temp';

        CanvasRenderer.drawWall(wallData, dataZoomLevel, false);

        // Restore IDs
        dataCanvas.id = 'dataWiringCanvas';
        if (originalCanvas) originalCanvas.id = 'wallCanvas2D';
      }

      updateDataZoomDisplay();
    }

    // Function to render power wiring diagram
    function renderPowerWiring() {
      window.showWiring = false;
      window.showPower = true;

      // Temporarily change the canvas ID that CanvasRenderer uses
      const originalCanvas = document.getElementById('wallCanvas2D');
      const powerCanvas = document.getElementById('powerWiringCanvas');

      // Copy ID to power canvas temporarily
      if (powerCanvas) {
        powerCanvas.id = 'wallCanvas2D';
        if (originalCanvas) originalCanvas.id = 'wallCanvas2D_temp';

        CanvasRenderer.drawWall(wallData, powerZoomLevel, false);

        // Restore IDs
        powerCanvas.id = 'powerWiringCanvas';
        if (originalCanvas) originalCanvas.id = 'wallCanvas2D';
      }

      updatePowerZoomDisplay();
    }

    // Data wiring zoom functions
    function dataZoomIn() {
      if (dataZoomLevel < 8) {
        dataZoomLevel++;
        renderDataWiring();
      }
    }

    function dataZoomOut() {
      if (dataZoomLevel > 1) {
        dataZoomLevel--;
        renderDataWiring();
      }
    }

    function updateDataZoomDisplay() {
      document.getElementById('dataZoomLevel').textContent = `Zoom: ${dataZoomLevel}`;
    }

    // Power wiring zoom functions
    function powerZoomIn() {
      if (powerZoomLevel < 8) {
        powerZoomLevel++;
        renderPowerWiring();
      }
    }

    function powerZoomOut() {
      if (powerZoomLevel > 1) {
        powerZoomLevel--;
        renderPowerWiring();
      }
    }

    function updatePowerZoomDisplay() {
      document.getElementById('powerZoomLevel').textContent = `Zoom: ${powerZoomLevel}`;
    }

    // Data wiring controls
    const wiringDirectionSelect = document.getElementById('wiringDirection');
    const wiringStartPositionSelect = document.getElementById('wiringStartPosition');

    if (wiringDirectionSelect) {
      wiringDirectionSelect.addEventListener('change', () => {
        window.wiringDirection = wiringDirectionSelect.value;
        renderDataWiring();
      });
    }

    if (wiringStartPositionSelect) {
      wiringStartPositionSelect.addEventListener('change', () => {
        window.wiringStartPosition = wiringStartPositionSelect.value;
        renderDataWiring();
      });
    }

    // Power wiring controls
    const powerDirectionSelect = document.getElementById('powerDirection');
    const powerStartPositionSelect = document.getElementById('powerStartPosition');

    if (powerDirectionSelect) {
      powerDirectionSelect.addEventListener('change', () => {
        window.powerDirection = powerDirectionSelect.value;
        renderPowerWiring();
      });
    }

    if (powerStartPositionSelect) {
      powerStartPositionSelect.addEventListener('change', () => {
        window.powerStartPosition = powerStartPositionSelect.value;
        renderPowerWiring();
      });
    }

    if (powerDistroTypeSelect) {
      powerDistroTypeSelect.addEventListener('change', () => {
        renderPowerWiring();
      });
    }

    // Zoom controls
    document.getElementById('dataZoomInButton').addEventListener('click', dataZoomIn);
    document.getElementById('dataZoomOutButton').addEventListener('click', dataZoomOut);
    document.getElementById('powerZoomInButton').addEventListener('click', powerZoomIn);
    document.getElementById('powerZoomOutButton').addEventListener('click', powerZoomOut);

    // Capture data wiring diagram
    function captureDataWiring() {
      const canvas = document.getElementById('dataWiringCanvas');
      if (!canvas) return;

      // Create temporary canvas with extra height for info text
      const tempCanvas = document.createElement('canvas');
      const infoHeight = 80;
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height + infoHeight;
      const ctx = tempCanvas.getContext('2d');

      // Fill with white background
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

      // Copy original canvas content
      ctx.drawImage(canvas, 0, 0);

      // Add info text
      const productType = params.productType || 'LED';
      const blocksHor = params.blocksHor || '10';
      const blocksVer = params.blocksVer || '6';

      // Draw info section background
      ctx.fillStyle = '#f0f0f0';
      ctx.fillRect(0, canvas.height, tempCanvas.width, infoHeight);

      // Draw text
      ctx.fillStyle = '#000000';
      ctx.font = 'bold 20px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('Data Wiring Diagram', tempCanvas.width / 2, canvas.height + 30);
      ctx.font = '16px Arial';
      ctx.fillText(`${displayName} - ${blocksHor} √ó ${blocksVer} tiles`, tempCanvas.width / 2, canvas.height + 55);

      // Convert to data URL and download
      const dataURL = tempCanvas.toDataURL('image/png');
      const link = document.createElement('a');
      link.download = `${productType.toUpperCase()}_Data_Wiring_${blocksHor}x${blocksVer}.png`;
      link.href = dataURL;
      link.click();
    }

    // Capture power wiring diagram
    function capturePowerWiring() {
      const canvas = document.getElementById('powerWiringCanvas');
      if (!canvas) return;

      // Create temporary canvas with extra height for info text
      const tempCanvas = document.createElement('canvas');
      const infoHeight = 80;
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height + infoHeight;
      const ctx = tempCanvas.getContext('2d');

      // Fill with white background
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

      // Copy original canvas content
      ctx.drawImage(canvas, 0, 0);

      // Add info text
      const productType = params.productType || 'LED';
      const blocksHor = params.blocksHor || '10';
      const blocksVer = params.blocksVer || '6';
      const voltage = powerDistroTypeSelect.value;

      // Draw info section background
      ctx.fillStyle = '#f0f0f0';
      ctx.fillRect(0, canvas.height, tempCanvas.width, infoHeight);

      // Draw text
      ctx.fillStyle = '#000000';
      ctx.font = 'bold 20px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(`Power Wiring Diagram (${voltage}V)`, tempCanvas.width / 2, canvas.height + 30);
      ctx.font = '16px Arial';
      ctx.fillText(`${displayName} - ${blocksHor} √ó ${blocksVer} tiles`, tempCanvas.width / 2, canvas.height + 55);

      // Convert to data URL and download
      const dataURL = tempCanvas.toDataURL('image/png');
      const link = document.createElement('a');
      link.download = `${productType.toUpperCase()}_Power_Wiring_${voltage}V_${blocksHor}x${blocksVer}.png`;
      link.href = dataURL;
      link.click();
    }

    // Capture both diagrams
    function captureBothDiagrams() {
      const dataCanvas = document.getElementById('dataWiringCanvas');
      const powerCanvas = document.getElementById('powerWiringCanvas');
      if (!dataCanvas || !powerCanvas) return;

      const infoHeight = 80;
      const spacing = 30; // Space between diagrams

      // Create temporary canvas to combine both diagrams
      const tempCanvas = document.createElement('canvas');
      const maxWidth = Math.max(dataCanvas.width, powerCanvas.width);
      tempCanvas.width = maxWidth;
      tempCanvas.height = dataCanvas.height + infoHeight + spacing + powerCanvas.height + infoHeight;
      const ctx = tempCanvas.getContext('2d');

      // Fill with white background
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

      // Position for data diagram (centered if narrower than max width)
      let currentY = 0;
      const dataX = (maxWidth - dataCanvas.width) / 2;

      // Draw data wiring canvas
      ctx.drawImage(dataCanvas, dataX, currentY);

      // Add info section for data wiring
      currentY += dataCanvas.height;
      ctx.fillStyle = '#f0f0f0';
      ctx.fillRect(0, currentY, tempCanvas.width, infoHeight);

      ctx.fillStyle = '#000000';
      ctx.font = 'bold 20px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('Data Wiring Diagram', tempCanvas.width / 2, currentY + 30);
      ctx.font = '16px Arial';
      ctx.fillText(`${displayName} - ${params.blocksHor} √ó ${params.blocksVer} tiles`, tempCanvas.width / 2, currentY + 55);

      // Move to power diagram position with spacing
      currentY += infoHeight + spacing;
      const powerX = (maxWidth - powerCanvas.width) / 2;

      // Draw power wiring canvas
      ctx.drawImage(powerCanvas, powerX, currentY);

      // Add info section for power wiring
      currentY += powerCanvas.height;
      ctx.fillStyle = '#f0f0f0';
      ctx.fillRect(0, currentY, tempCanvas.width, infoHeight);

      const voltage = powerDistroTypeSelect.value;
      ctx.fillStyle = '#000000';
      ctx.font = 'bold 20px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(`Power Wiring Diagram (${voltage}V)`, tempCanvas.width / 2, currentY + 30);
      ctx.font = '16px Arial';
      ctx.fillText(`${displayName} - ${params.blocksHor} √ó ${params.blocksVer} tiles`, tempCanvas.width / 2, currentY + 55);

      // Convert to data URL and download
      const dataURL = tempCanvas.toDataURL('image/png');
      const link = document.createElement('a');
      const productType = params.productType || 'LED';
      link.download = `${productType.toUpperCase()}_Complete_Wiring_Diagrams_${params.blocksHor}x${params.blocksVer}.png`;
      link.href = dataURL;
      link.click();
    }

    // Capture button event listeners
    document.getElementById('captureDataButton').addEventListener('click', captureDataWiring);
    document.getElementById('capturePowerButton').addEventListener('click', capturePowerWiring);
    document.getElementById('captureBothButton').addEventListener('click', captureBothDiagrams);

    // Create a hidden select element for product type (needed by canvas.js)
    const hiddenProductSelect = document.createElement('select');
    hiddenProductSelect.id = 'productType';
    hiddenProductSelect.style.display = 'none';
    const option = document.createElement('option');
    option.value = params.productType;
    option.selected = true;
    hiddenProductSelect.appendChild(option);
    document.body.appendChild(hiddenProductSelect);

    // Initial render of both diagrams (deferred to allow DOM layout to complete)
    requestAnimationFrame(() => {
      renderDataWiring();
      renderPowerWiring();
    });
  </script>
</body>
</html>
